<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å®¶æ—ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ v7ï¼ˆiPhoneæœ€é© / éŸ³ / èŠ±å¹é›ª / ã‚»ãƒƒãƒˆå¼ï¼‰</title>
<style>
  :root{
    --bg:#f6f6f7;
    --card:#fff;
    --line:#e8e8ea;
    --text:#111;
    --muted:#666;
    --primary:#111;
    --danger:#b91c1c;
    --r:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  .wrap{
    max-width: 560px;
    margin: 0 auto;
    padding: 14px 12px 24px;
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  h1{
    font-size:18px;
    margin:0;
    letter-spacing:.2px;
  }
  .badge{
    font-size:12px;
    color:var(--muted);
    border:1px solid var(--line);
    background:var(--card);
    padding:6px 10px;
    border-radius:999px;
    white-space:nowrap;
  }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius: var(--r);
    padding: 12px;
  }

  .wheelBox{
    position:relative;
    display:flex;
    justify-content:center;
    align-items:center;
    padding: 10px 0 6px;
  }
  canvas#wheel{
    display:block;
    border-radius: 999px;
    box-shadow: 0 10px 24px rgba(0,0,0,.10);
    background:#fff;
  }
  canvas#confetti{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    pointer-events:none;
  }

  .result{
    margin-top:10px;
    text-align:center;
    font-weight:900;
    font-size:22px;
  }
  .hint{
    margin-top:6px;
    text-align:center;
    font-size:12px;
    color:var(--muted);
  }

  .controls{
    margin-top:10px;
    display:grid;
    gap:8px;
  }
  .row{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  input{
    flex:1;
    min-width: 160px;
    font-size:16px;
    padding:12px 12px;
    border-radius: 12px;
    border:1px solid var(--line);
    background:#fff;
    outline:none;
  }
  button{
    font-size:16px;
    padding:12px 12px;
    border-radius: 12px;
    border:1px solid var(--line);
    background:#fff;
    cursor:pointer;
    white-space:nowrap;
  }
  button.primary{
    background:var(--primary);
    color:#fff;
    border-color:var(--primary);
  }
  button.danger{
    background:var(--danger);
    color:#fff;
    border-color:var(--danger);
  }
  button:disabled{opacity:.5; cursor:not-allowed}

  .toggles{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    justify-content:center;
    margin-top:6px;
  }
  .toggle{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:14px;
    padding:8px 10px;
    border:1px solid var(--line);
    background:var(--card);
    border-radius:999px;
  }
  .toggle input{transform:scale(1.1)}

  details{
    margin-top:12px;
  }
  details > summary{
    list-style:none;
    cursor:pointer;
    user-select:none;
    font-weight:800;
    padding: 10px 12px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius: var(--r);
  }
  .section{
    border:1px solid var(--line);
    border-top:none;
    background:var(--card);
    border-bottom-left-radius: var(--r);
    border-bottom-right-radius: var(--r);
    padding: 10px 10px 12px;
  }

  .items{
    display:grid;
    grid-template-columns: 1fr auto auto auto auto;
    gap: 8px 8px;
    align-items:center;
  }
  .pill{
    border:1px solid var(--line);
    background:#fff;
    padding: 8px 10px;
    border-radius: 999px;
    font-size:14px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .pill.nameBtn{cursor:pointer}
  .wbox{
    min-width:44px;
    text-align:center;
    font-weight:900;
  }
  .mini{
    padding:8px 10px;
    font-size:14px;
    border-radius:999px;
  }

  .history{
    margin-top:10px;
    font-size:12px;
    color:var(--muted);
    text-align:left;
  }

  textarea{
    width:100%;
    height:120px;
    border-radius:12px;
    border:1px solid var(--line);
    padding:10px 12px;
    font-size:14px;
    font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  }
  .subrow{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px;
    justify-content:flex-start;
  }
  .msg{
    margin-top:8px;
    font-size:12px;
    color:var(--muted);
  }
  .ok{color:#0f766e; font-weight:700}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <h1>ğŸ½ å®¶æ—ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h1>
    <div class="badge">v7 iPhone / éŸ³ / èŠ±å¹é›ª</div>
  </header>

  <div class="card">
    <div class="wheelBox" id="wheelBox">
      <canvas id="wheel"></canvas>
      <canvas id="confetti"></canvas>
    </div>

    <div id="result" class="result">â€”</div>
    <div class="hint" id="hint">ã€Œãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã€â†’ã€Œå›ã™ã€</div>

    <div class="controls">
      <div class="row">
        <input id="item" placeholder="è¿½åŠ ï¼ˆä¾‹ï¼šã‚«ãƒ¬ãƒ¼ï¼‰" inputmode="text" />
        <button id="addBtn">è¿½åŠ </button>
      </div>

      <div class="row">
        <button id="setBtn">ğŸ§© ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆ</button>
        <button id="spinBtn" class="primary">ğŸ¯ å›ã™</button>
        <button id="soundBtn">ğŸ”Š éŸ³: ON</button>
      </div>

      <div class="row">
        <button id="delLastBtn">æœ€å¾Œå‰Šé™¤</button>
        <button id="clearHistBtn">å±¥æ­´ã‚¯ãƒªã‚¢</button>
        <button id="resetBtn" class="danger">åˆæœŸåŒ–</button>
      </div>

      <div class="toggles">
        <label class="toggle"><input id="avoidChk" type="checkbox" checked>æœ€è¿‘å‡ºãŸã®ã‚’æ¸›è¡°</label>
        <label class="toggle"><input id="noRepeatChk" type="checkbox" checked>ç›´å‰ã¯çµ¶å¯¾å‡ºãªã„</label>
      </div>
    </div>

    <details>
      <summary>å€™è£œã‚’ç·¨é›†ï¼ˆé‡ã¿èª¿æ•´ / å‰Šé™¤ï¼‰</summary>
      <div class="section">
        <div id="rows" class="items"></div>
        <div class="history">å±¥æ­´ï¼ˆæœ€æ–°5ï¼‰ï¼š<span id="hist">â€”</span></div>
        <div class="msg">â€» å€™è£œåã¯ã‚¿ãƒƒãƒ—ã§ç·¨é›†ã€‚å¤‰æ›´ã—ãŸã‚‰ã€Œãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã€ã—ã¦ã­</div>
      </div>
    </details>

    <details>
      <summary>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰</summary>
      <div class="section">
        <textarea id="backup" placeholder="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ã“ã“ã«JSON / ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸã„JSONã‚‚ã“ã“ã«è²¼ã‚‹"></textarea>
        <div class="subrow">
          <button id="exportBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button id="importBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
        <div id="backupMsg" class="msg">â€”</div>
      </div>
    </details>
  </div>
</div>

<script>
/* =========================
   åŸºæœ¬
========================= */
const STORAGE_KEY = "family_roulette_v7";
const TAU = Math.PI * 2;
const POINTER_WORLD = -Math.PI / 2; // çŸ¢å°ã¯ä¸Šï¼ˆ12æ™‚ï¼‰

function norm(a){ a = a % TAU; return a < 0 ? a + TAU : a; }
function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }
function easeOutCubic(x){ return 1 - Math.pow(1-x, 3); }

/* =========================
   åˆæœŸå€¤ãƒ»ä¿å­˜
========================= */
function defaultState(){
  return {
    items: ["ä¸¸äº€è£½éºº","ã‚¬ã‚¹ãƒˆ","ãƒãƒƒã‚¯","ãƒ”ã‚¶","ã•ã°ã”ã¯ã‚“","ãƒã‚«ãƒ­ãƒ‹ã‚µãƒ©ãƒ€","ãŠã†ã¡ãƒãƒ³ãƒãƒ¼ã‚°"],
    weights: [3,2,4,1,2,2,2],
    history: [],
    avoidRecent: true,
    noRepeat: true,
    soundOn: true
  };
}

function sanitizeState(s){
  const d = defaultState();
  const items = Array.isArray(s.items) ? s.items.map(String) : d.items.slice();
  const weights = Array.isArray(s.weights) ? s.weights.map(x=>{
    const n = Number(x);
    return (isFinite(n) && n > 0) ? n : 1;
  }) : d.weights.slice();

  const L = Math.min(items.length, weights.length);
  const okLen = (L >= 2) ? L : d.items.length;

  return {
    items: items.slice(0, okLen),
    weights: weights.slice(0, okLen),
    history: Array.isArray(s.history) ? s.history.map(String).slice(0, 30) : [],
    avoidRecent: typeof s.avoidRecent === "boolean" ? s.avoidRecent : d.avoidRecent,
    noRepeat: typeof s.noRepeat === "boolean" ? s.noRepeat : d.noRepeat,
    soundOn: typeof s.soundOn === "boolean" ? s.soundOn : d.soundOn
  };
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    return sanitizeState(JSON.parse(raw));
  }catch{
    return defaultState();
  }
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    items, weights, history,
    avoidRecent: avoidChk.checked,
    noRepeat: noRepeatChk.checked,
    soundOn
  }));
}

/* =========================
   DOM
========================= */
const wheelBox = document.getElementById("wheelBox");

const wheel = document.getElementById("wheel");
const wctx = wheel.getContext("2d");

const conf = document.getElementById("confetti");
const cctx = conf.getContext("2d");

const itemInput = document.getElementById("item");
const addBtn = document.getElementById("addBtn");
const setBtn = document.getElementById("setBtn");
const spinBtn = document.getElementById("spinBtn");
const soundBtn = document.getElementById("soundBtn");
const delLastBtn = document.getElementById("delLastBtn");
const clearHistBtn = document.getElementById("clearHistBtn");
const resetBtn = document.getElementById("resetBtn");

const avoidChk = document.getElementById("avoidChk");
const noRepeatChk = document.getElementById("noRepeatChk");

const rowsEl = document.getElementById("rows");
const histEl = document.getElementById("hist");
const resultEl = document.getElementById("result");
const hintEl = document.getElementById("hint");

const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const backupTa = document.getElementById("backup");
const backupMsg = document.getElementById("backupMsg");

/* =========================
   çŠ¶æ…‹
========================= */
let { items, weights, history, avoidRecent, noRepeat, soundOn } = loadState();
avoidChk.checked = avoidRecent;
noRepeatChk.checked = noRepeat;

let angle = 0;
let spinning = false;

// ã‚¹ãƒ”ãƒ³ä¸­å›ºå®š
let spinSegments = null;
// ç›¤é¢å›ºå®šï¼ˆã‚»ãƒƒãƒˆã§ç¢ºå®šï¼‰
let lockedSegments = null;

// Canvasã‚µã‚¤ã‚º
let cssSize = 320;
let dpr = 1;

// å›è»¢éŸ³ï¼šå‰å›ã®å½“é¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆåˆ‡ã‚Šæ›¿ã‚ã‚Šã§tickï¼‰
let lastTickIndex = -1;

/* =========================
   éŸ³ï¼ˆWebAudioï¼‰ iOSå¯¾ç­–ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§åˆæœŸåŒ–
========================= */
let audioCtx = null;
let soundReady = false;

function ensureAudio(){
  if(!soundOn) return;
  if(soundReady) return;

  const AC = window.AudioContext || window.webkitAudioContext;
  if(!AC) return;

  audioCtx = audioCtx || new AC();
  // iOSã¯suspendedã®å ´åˆãŒã‚ã‚‹
  if(audioCtx.state === "suspended"){
    audioCtx.resume().catch(()=>{});
  }
  soundReady = true;
}

function playTick(){
  if(!soundOn) return;
  ensureAudio();
  if(!audioCtx) return;

  const t = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();

  o.type = "square";
  o.frequency.setValueAtTime(820 + Math.random()*40, t);
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.05, t + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.06);

  o.connect(g).connect(audioCtx.destination);
  o.start(t);
  o.stop(t + 0.07);
}

function playWin(){
  if(!soundOn) return;
  ensureAudio();
  if(!audioCtx) return;

  const t = audioCtx.currentTime;
  const freqs = [523.25, 659.25, 783.99]; // C5 E5 G5
  freqs.forEach((f, i)=>{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(f, t);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.12, t + 0.01 + i*0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.35);
    o.connect(g).connect(audioCtx.destination);
    o.start(t);
    o.stop(t + 0.38);
  });
}

/* =========================
   èŠ±å¹é›ªï¼ˆè»½é‡ï¼‰
========================= */
let confettiRunning = false;
let confettiParts = [];

function startConfetti(){
  // é€£æ‰“ã§ã‚‚é‡ããªã‚‰ãªã„ã‚ˆã†ã«
  confettiParts = [];
  confettiRunning = true;

  const W = cssSize, H = cssSize;
  const n = 90;

  for(let i=0;i<n;i++){
    confettiParts.push({
      x: W/2 + (Math.random()-0.5)*40,
      y: H*0.22 + (Math.random()-0.5)*10,
      vx: (Math.random()-0.5)*2.6,
      vy: 1.8 + Math.random()*2.4,
      rot: Math.random()*TAU,
      vr: (Math.random()-0.5)*0.25,
      w: 6 + Math.random()*8,
      h: 5 + Math.random()*10,
      life: 60 + Math.random()*40,
      hue: Math.floor(Math.random()*360)
    });
  }

  const t0 = performance.now();
  function step(t){
    if(!confettiRunning) return;
    const dt = (t - t0) / 1000; // å‚ç…§ã ã‘ï¼ˆä½¿ã‚ãªãã¦ã‚‚OKï¼‰

    cctx.clearRect(0,0,W,H);
    for(const p of confettiParts){
      p.life -= 1;
      p.vy += 0.03; // gravity
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;

      cctx.save();
      cctx.translate(p.x, p.y);
      cctx.rotate(p.rot);
      cctx.fillStyle = `hsl(${p.hue}, 85%, 60%)`;
      cctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      cctx.restore();
    }

    confettiParts = confettiParts.filter(p => p.life > 0 && p.y < H + 30);

    if(confettiParts.length > 0){
      requestAnimationFrame(step);
    }else{
      confettiRunning = false;
      cctx.clearRect(0,0,W,H);
    }
  }
  requestAnimationFrame(step);
}

/* =========================
   Canvasãƒªã‚µã‚¤ã‚ºï¼ˆiPhoneã‚ºãƒ¬/ã«ã˜ã¿å¯¾ç­–ï¼‰
========================= */
function resizeCanvases(){
  const vw = Math.min(window.innerWidth, 560);
  cssSize = clamp(Math.floor(vw - 48), 260, 420);
  dpr = window.devicePixelRatio || 1;

  // wheel
  wheel.style.width = cssSize + "px";
  wheel.style.height = cssSize + "px";
  wheel.width = Math.floor(cssSize * dpr);
  wheel.height = Math.floor(cssSize * dpr);
  wctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  // confetti overlay (CSSã‚µã‚¤ã‚ºã§æç”»ã™ã‚‹)
  conf.style.width = cssSize + "px";
  conf.style.height = cssSize + "px";
  conf.width = Math.floor(cssSize * dpr);
  conf.height = Math.floor(cssSize * dpr);
  cctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  drawWheel();
}

/* =========================
   é‡ã¿ â†’ æœ‰åŠ¹é‡ã¿
========================= */
const HISTORY_LEN = 5;
const RECENT_DECAY = 0.6;

function computeEffectiveWeights(){
  const n = items.length;
  let eff = weights.map(w => {
    const base = Number(w);
    return (isFinite(base) && base > 0) ? base : 1;
  });

  if (avoidChk.checked){
    const recent = history.slice(0, HISTORY_LEN);
    const count = new Map();
    for(const x of recent) count.set(x, (count.get(x)||0) + 1);
    for(let i=0;i<n;i++){
      const c = count.get(items[i]) || 0;
      eff[i] = eff[i] * Math.pow(RECENT_DECAY, c);
    }
  }

  if (noRepeatChk.checked && history.length > 0 && n >= 2){
    const last = history[0];
    for(let i=0;i<n;i++){
      if(items[i] === last) eff[i] = 0;
    }
  }

  const sum = eff.reduce((a,b)=>a+b,0);
  if (sum <= 0){
    eff = weights.map(w => {
      const base = Number(w);
      return (isFinite(base) && base > 0) ? base : 1;
    });
  }
  return eff;
}

/* =========================
   ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
========================= */
function buildSegments(eff){
  const safe = eff.map(w => (isFinite(w) && w > 0) ? w : 0);
  const sum = safe.reduce((a,b)=>a+b,0);

  let cur = 0;
  const segs = [];
  for(let i=0;i<items.length;i++){
    const span = (safe[i] / sum) * TAU;
    const s = cur;
    const e = cur + span;
    segs.push({ name: items[i], s, e, idx:i });
    cur = e;
  }
  return segs;
}

/* =========================
   æç”»ï¼ˆç›¤é¢å›ºå®šå„ªå…ˆï¼‰
========================= */
function drawWheel(){
  const W = cssSize, H = cssSize;
  const cx = W/2, cy = H/2, r = W/2 - 2;

  wctx.clearRect(0,0,W,H);

  const segs = spinSegments ?? lockedSegments ?? buildSegments(computeEffectiveWeights());
  const N = segs.length;

  wctx.font = "14px system-ui";
  wctx.textBaseline = "middle";

  for(let i=0;i<N;i++){
    const g = segs[i];
    const a0 = angle + g.s;
    const a1 = angle + g.e;

    wctx.beginPath();
    wctx.moveTo(cx,cy);
    wctx.arc(cx,cy,r,a0,a1);
    wctx.closePath();
    wctx.fillStyle = `hsl(${(i*360/N)|0}, 82%, 72%)`;
    wctx.fill();
    wctx.strokeStyle = "rgba(0,0,0,.10)";
    wctx.stroke();

    // ãƒ©ãƒ™ãƒ«
    const mid = (a0 + a1) / 2;
    wctx.save();
    wctx.translate(cx,cy);
    wctx.rotate(mid);
    wctx.textAlign = "right";
    wctx.fillStyle = "rgba(0,0,0,.78)";
    wctx.fillText(g.name, r-16, 0);
    wctx.restore();
  }

  // ä¸­å¿ƒ
  wctx.beginPath();
  wctx.arc(cx,cy,18,0,TAU);
  wctx.fillStyle = "rgba(255,255,255,.92)";
  wctx.fill();
  wctx.strokeStyle = "rgba(0,0,0,.10)";
  wctx.stroke();

  // çŸ¢å°ï¼ˆä¸Šä¸­å¤®å›ºå®šï¼‰
  wctx.fillStyle = "#e11";
  wctx.beginPath();
  wctx.moveTo(cx-14, 8);
  wctx.lineTo(cx+14, 8);
  wctx.lineTo(cx, 30);
  wctx.closePath();
  wctx.fill();
  wctx.strokeStyle = "rgba(0,0,0,.12)";
  wctx.stroke();
}

function pointedIndex(){
  const segs = spinSegments ?? lockedSegments ?? buildSegments(computeEffectiveWeights());
  const a = norm(POINTER_WORLD - angle);
  for(const s of segs){
    if (a >= s.s - 1e-12 && a < s.e + 1e-12) return s.idx;
  }
  return segs[segs.length-1]?.idx ?? 0;
}

function pointedName(){
  return items[pointedIndex()] ?? "";
}

/* =========================
   æ­¢ã¾ã‚‹è§’åº¦ï¼šé‡ã¿ã«æ¯”ä¾‹ï¼ˆspinSegmentså‰æï¼‰
========================= */
function sampleStopAngleByWeight(){
  const segs = spinSegments;

  const safe = [];
  let total = 0;

  for(const s of segs){
    const span = s.e - s.s;
    const eps = Math.min(span * 0.08, 0.03);
    const low = s.s + eps;
    const high = s.e - eps;
    const w = Math.max(0, high - low);
    safe.push({ low, high, w });
    total += w;
  }

  if (total <= 0){
    const t = Math.random() * TAU;
    return norm(POINTER_WORLD - t);
  }

  let r = Math.random() * total;
  let chosen = safe[safe.length-1];
  for(const x of safe){
    r -= x.w;
    if (r <= 0){ chosen = x; break; }
  }

  const t = chosen.low + Math.random() * (chosen.high - chosen.low);
  return norm(POINTER_WORLD - t);
}

/* =========================
   å›è»¢ã‚¢ãƒ‹ãƒ¡ï¼ˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ã‚ã‚Šã§tickéŸ³ï¼‰
========================= */
function animateSpinTo(targetAngle){
  return new Promise(resolve=>{
    const start = angle;
    const extraTurns = 4 + Math.floor(Math.random()*4);
    const target = targetAngle + extraTurns * TAU;

    let delta = target - start;
    if (delta < 0) delta += Math.ceil((-delta)/TAU) * TAU;

    const duration = 1500 + extraTurns * 240;
    const t0 = performance.now();

    // tickåˆ¤å®šåˆæœŸåŒ–
    lastTickIndex = pointedIndex();

    function step(t){
      const p = clamp((t - t0) / duration, 0, 1);
      const e = easeOutCubic(p);
      angle = norm(start + delta * e);

      drawWheel();

      // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒå¤‰ã‚ã£ãŸã‚‰tick
      const idx = pointedIndex();
      if(idx !== lastTickIndex){
        lastTickIndex = idx;
        playTick();
      }

      if (p < 1) requestAnimationFrame(step);
      else resolve();
    }
    requestAnimationFrame(step);
  });
}

/* =========================
   UIï¼šå€™è£œè¡¨ç¤ºï¼ˆç·¨é›† / é‡ã¿ / å‰Šé™¤ï¼‰
========================= */
function renderRows(){
  rowsEl.innerHTML = "";
  for(let i=0;i<items.length;i++){
    const nameBtn = document.createElement("div");
    nameBtn.className = "pill nameBtn";
    nameBtn.textContent = items[i];
    nameBtn.title = "ã‚¿ãƒƒãƒ—ã§ç·¨é›†";
    nameBtn.onclick = ()=> startEditName(i);

    const w = document.createElement("div");
    w.className = "pill wbox";
    w.textContent = String(weights[i]);

    const minus = document.createElement("button");
    minus.className = "mini";
    minus.textContent = "âˆ’";
    minus.onclick = ()=>{
      weights[i] = Math.max(1, Number(weights[i]||1) - 1);
      saveState();
      lockedSegments = null;
      hintEl.textContent = "å€™è£œ/é‡ã¿ã‚’å¤‰æ›´ã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";
      renderRows();
    };

    const plus = document.createElement("button");
    plus.className = "mini";
    plus.textContent = "ï¼‹";
    plus.onclick = ()=>{
      weights[i] = Math.min(99, Number(weights[i]||1) + 1);
      saveState();
      lockedSegments = null;
      hintEl.textContent = "å€™è£œ/é‡ã¿ã‚’å¤‰æ›´ã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";
      renderRows();
    };

    const del = document.createElement("button");
    del.className = "mini";
    del.textContent = "ğŸ—‘";
    del.onclick = ()=>{
      if(items.length <= 2) return;
      const removed = items[i];
      items.splice(i,1);
      weights.splice(i,1);
      history = history.filter(x=>x!==removed);

      lockedSegments = null;
      resultEl.textContent = "â€”";
      hintEl.textContent = "å€™è£œã‚’å‰Šé™¤ã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";

      saveState();
      renderRows();
      drawWheel();
    };

    rowsEl.appendChild(nameBtn);
    rowsEl.appendChild(w);
    rowsEl.appendChild(minus);
    rowsEl.appendChild(plus);
    rowsEl.appendChild(del);
  }

  histEl.textContent = history.length ? history.slice(0,5).join(" / ") : "â€”";
}

function startEditName(i){
  // ãã®å ´ã§promptã¯å‘³æ°—ãªã„ã®ã§ã€å…¥åŠ›UIã‚’ä¸€æ™‚çš„ã«å·®ã—è¾¼ã‚€ï¼ˆè»½é‡ï¼‰
  const current = items[i];

  // rowsã®å­ã¯ 1è¡Œ=5è¦ç´ 
  const children = Array.from(rowsEl.children);
  const base = i * 5;

  const input = document.createElement("input");
  input.value = current;
  input.style.padding = "10px 12px";
  input.style.borderRadius = "999px";
  input.style.border = "1px solid var(--line)";

  const ok = document.createElement("button");
  ok.className = "mini";
  ok.textContent = "OK";

  const cancel = document.createElement("button");
  cancel.className = "mini";
  cancel.textContent = "æˆ»ã™";

  const commit = ()=>{
    const v = input.value.trim();
    if(!v) return;
    const old = items[i];
    items[i] = v;
    history = history.map(x => (x === old ? v : x));

    lockedSegments = null;
    resultEl.textContent = "â€”";
    hintEl.textContent = "å€™è£œåã‚’æ›´æ–°ã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";

    saveState();
    renderRows();
    drawWheel();
  };

  ok.onclick = commit;
  cancel.onclick = ()=>{ renderRows(); };

  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") commit();
    if(e.key === "Escape") renderRows();
  });

  // ç½®æ›ï¼ˆåå‰ãƒ»é‡ã¿ãƒ»- ã®3æ ã‚’ input/ok/cancel ã«ä¸€æ™‚ä½¿ç”¨ï¼‰
  rowsEl.replaceChild(input, children[base]);
  rowsEl.replaceChild(ok, children[base+1]);
  rowsEl.replaceChild(cancel, children[base+2]);

  input.focus();
  input.select();
}

/* =========================
   æ“ä½œ
========================= */
function setRoulette(){
  ensureAudio(); // iOSã§éŸ³ãŒé³´ã‚‹ã‚ˆã†ã«æ—©ã‚ã«èµ·å‹•
  if(items.length < 2){
    hintEl.textContent = "å€™è£œã¯2ã¤ä»¥ä¸Šå¿…è¦ã§ã™";
    return;
  }
  lockedSegments = buildSegments(computeEffectiveWeights());
  resultEl.textContent = "â€”";
  hintEl.textContent = "ã‚»ãƒƒãƒˆå®Œäº† â†’ å›ã›ã¾ã™";
  saveState();
  drawWheel();
}

async function spin(){
  ensureAudio();
  if(spinning) return;
  if(items.length < 2) return;
  if(!lockedSegments){
    hintEl.textContent = "å…ˆã«ã€Œãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã€ã‚’æŠ¼ã—ã¦ã­";
    return;
  }

  spinning = true;
  spinBtn.disabled = addBtn.disabled = delLastBtn.disabled = clearHistBtn.disabled = resetBtn.disabled = true;
  setBtn.disabled = true;

  // ã‚¹ãƒ”ãƒ³ä¸­å›ºå®šï¼šã‚»ãƒƒãƒˆæ¸ˆã¿ç›¤é¢ã‚’ãã®ã¾ã¾åˆ©ç”¨
  spinSegments = lockedSegments;

  const stopAngle = sampleStopAngleByWeight();
  await animateSpinTo(stopAngle);

  const winner = pointedName();

  history.unshift(winner);
  history = history.slice(0, 30);

  resultEl.textContent = `âœ… ${winner}`;
  hintEl.textContent = "æ±ºå®šï¼ã‚‚ã†ä¸€å›å›ã™ãªã‚‰ãã®ã¾ã¾ã€Œå›ã™ã€ã§OK";

  saveState();
  renderRows();

  // æ±ºå®šæ¼”å‡º
  playWin();
  startConfetti();

  spinSegments = null;
  spinning = false;

  spinBtn.disabled = addBtn.disabled = delLastBtn.disabled = clearHistBtn.disabled = resetBtn.disabled = false;
  setBtn.disabled = false;

  drawWheel();
}

function addItem(){
  ensureAudio();
  const v = itemInput.value.trim();
  if(!v) return;

  items.push(v);
  weights.push(1);
  itemInput.value = "";

  lockedSegments = null;
  resultEl.textContent = "â€”";
  hintEl.textContent = "å€™è£œã‚’è¿½åŠ ã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";

  saveState();
  renderRows();
  drawWheel();
}

function delLast(){
  ensureAudio();
  if(items.length <= 2) return;
  const removed = items[items.length-1];
  items.pop();
  weights.pop();
  history = history.filter(x=>x!==removed);

  lockedSegments = null;
  resultEl.textContent = "â€”";
  hintEl.textContent = "å€™è£œã‚’å‰Šé™¤ã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";

  saveState();
  renderRows();
  drawWheel();
}

function clearHistory(){
  ensureAudio();
  history = [];
  lockedSegments = null; // æ¸›è¡°æ¡ä»¶ãŒå¤‰ã‚ã‚‹ã®ã§ç›¤é¢ã‚‚è§£é™¤
  resultEl.textContent = "â€”";
  hintEl.textContent = "å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";

  saveState();
  renderRows();
  drawWheel();
}

function resetAll(){
  ensureAudio();
  const d = defaultState();
  items = d.items.slice();
  weights = d.weights.slice();
  history = [];
  avoidChk.checked = true;
  noRepeatChk.checked = true;

  angle = 0;
  lockedSegments = null;

  resultEl.textContent = "â€”";
  hintEl.textContent = "åˆæœŸåŒ–ã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";

  soundOn = true;
  updateSoundUI();

  saveState();
  renderRows();
  drawWheel();
}

/* =========================
   ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
========================= */
function exportState(){
  const s = {
    items, weights, history,
    avoidRecent: avoidChk.checked,
    noRepeat: noRepeatChk.checked,
    soundOn
  };
  backupTa.value = JSON.stringify(s, null, 2);
  backupMsg.textContent = "âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜OKï¼‰";
  backupMsg.className = "msg ok";
}

function importState(){
  try{
    const raw = backupTa.value.trim();
    if(!raw) return;

    const s = sanitizeState(JSON.parse(raw));
    items = s.items.slice();
    weights = s.weights.slice();
    history = s.history.slice();
    avoidChk.checked = s.avoidRecent;
    noRepeatChk.checked = s.noRepeat;
    soundOn = s.soundOn;

    angle = 0;
    lockedSegments = null;

    updateSoundUI();

    saveState();
    renderRows();
    drawWheel();

    resultEl.textContent = "â€”";
    hintEl.textContent = "ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";
    backupMsg.textContent = "âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ";
    backupMsg.className = "msg ok";
  }catch{
    backupMsg.textContent = "âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šJSONå½¢å¼ã‚’ç¢ºèªã—ã¦ã­";
    backupMsg.className = "msg";
  }
}

/* =========================
   éŸ³ãƒˆã‚°ãƒ«
========================= */
function updateSoundUI(){
  soundBtn.textContent = soundOn ? "ğŸ”Š éŸ³: ON" : "ğŸ”‡ éŸ³: OFF";
}
function toggleSound(){
  soundOn = !soundOn;
  updateSoundUI();
  saveState();
  // ONã«ã—ãŸç¬é–“ã«åˆæœŸåŒ–ã—ã¦ãŠãã¨æ¬¡ã®å›è»¢ã§é³´ã‚Šã‚„ã™ã„
  if(soundOn) ensureAudio();
}

/* =========================
   ã‚¤ãƒ™ãƒ³ãƒˆ
========================= */
addBtn.addEventListener("click", addItem);
itemInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") addItem(); });

setBtn.addEventListener("click", setRoulette);
spinBtn.addEventListener("click", spin);

soundBtn.addEventListener("click", toggleSound);

delLastBtn.addEventListener("click", delLast);
clearHistBtn.addEventListener("click", clearHistory);
resetBtn.addEventListener("click", resetAll);

avoidChk.addEventListener("change", ()=>{
  saveState();
  lockedSegments = null;
  hintEl.textContent = "è¨­å®šã‚’å¤‰æ›´ã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";
});
noRepeatChk.addEventListener("change", ()=>{
  saveState();
  lockedSegments = null;
  hintEl.textContent = "è¨­å®šã‚’å¤‰æ›´ã—ã¾ã—ãŸ â†’ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚»ãƒƒãƒˆã—ã¦ã­";
});

exportBtn.addEventListener("click", exportState);
importBtn.addEventListener("click", importState);

window.addEventListener("resize", ()=>{
  resizeCanvases();
});

/* =========================
   åˆæœŸè¡¨ç¤º
========================= */
updateSoundUI();
renderRows();
resizeCanvases();
// åˆå›ã¯è‡ªå‹•ã§ã‚»ãƒƒãƒˆã—ã¦ã™ãå›ã›ã‚‹ã‚ˆã†ã«ï¼ˆé•å’Œæ„Ÿã¯å‡ºãªã„ã‚ˆã†çµæœã¯â€”ï¼‰
setRoulette();
</script>
</body>
</html>
