<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ã”ã¯ã‚“ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆå®¶æ—ç‰ˆï¼‰</title>
<style>
  body{font-family:system-ui;margin:0;background:#fafafa;text-align:center}
  h1{margin:14px 0 6px}
  .wrap{max-width:520px;margin:0 auto;padding:12px}
  .stage{position:relative;display:inline-block;margin-top:8px}
  canvas#wheel{
    background:#fff;border-radius:50%;
    box-shadow:0 10px 25px rgba(0,0,0,.12);
    touch-action:manipulation;
  }
  canvas#fx{
    position:absolute;left:0;top:0;pointer-events:none;
  }
  .controls{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  input,button{font-size:16px;padding:10px 12px}
  button{cursor:pointer;border:1px solid #ddd;border-radius:12px;background:#fff}
  button.primary{background:#111;color:#fff;border-color:#111}
  button:disabled{opacity:.5;cursor:not-allowed}
  #result{
    margin:10px 0 0;font-size:26px;font-weight:800;
  }
  #sub{margin-top:4px;color:#555;font-size:13px}
  .list{
    margin-top:12px;text-align:left;background:#fff;border:1px solid #eee;
    border-radius:14px;padding:10px
  }
  .list h2{margin:0 0 8px;font-size:14px;color:#555}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{border:1px solid #e5e5e5;background:#fafafa;border-radius:999px;padding:6px 10px;font-size:13px}
  .pop{
    animation: pop .6s ease both;
  }
  @keyframes pop{
    0%{transform:scale(.9);filter:blur(.5px)}
    60%{transform:scale(1.08)}
    100%{transform:scale(1)}
  }
</style>
</head>

<body>
<div class="wrap">
  <h1>ğŸ½ å®¶æ—ã§å›ã™ï¼ã”ã¯ã‚“ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h1>
  <div class="stage">
    <canvas id="wheel" width="340" height="340"></canvas>
    <canvas id="fx" width="340" height="340"></canvas>
  </div>

  <div class="controls">
    <input id="item" placeholder="ä¾‹ï¼šã‚«ãƒ¬ãƒ¼" style="flex:1;min-width:220px">
    <button id="addBtn">è¿½åŠ </button>
    <button id="spinBtn" class="primary">ğŸ¯ å›ã™ï¼</button>
    <button id="delLastBtn" title="æœ€å¾Œã®å€™è£œã‚’å‰Šé™¤">æœ€å¾Œå‰Šé™¤</button>
    <button id="resetBtn" title="å€™è£œã‚’åˆæœŸåŒ–">åˆæœŸåŒ–</button>
  </div>

  <div id="result">â€”</div>
  <div id="sub">å€™è£œã‚’å…¥ã‚Œã¦ã€Œå›ã™ï¼ã€ï¼ˆéŸ³ã‚ã‚Šï¼†ç´™å¹é›ªï¼‰</div>

  <div class="list">
    <h2>å€™è£œ</h2>
    <div class="chips" id="chips"></div>
  </div>
</div>

<script>
/* ===========================
   çŠ¶æ…‹
=========================== */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

const fx = document.getElementById("fx");
const fctx = fx.getContext("2d");

const itemInput = document.getElementById("item");
const addBtn = document.getElementById("addBtn");
const spinBtn = document.getElementById("spinBtn");
const delLastBtn = document.getElementById("delLastBtn");
const resetBtn = document.getElementById("resetBtn");
const resultEl = document.getElementById("result");
const subEl = document.getElementById("sub");
const chipsEl = document.getElementById("chips");

let items = ["ä¸¸äº€è£½éºº","ã‚¬ã‚¹ãƒˆ","ãƒ”ã‚¶ãƒãƒƒãƒˆ","ãƒãƒƒã‚¯","ã•ã°ã”ã¯ã‚“","ã‚³ãƒ¼ãƒ³å¯¿å¸"];
let angle = 0;
let spinning = false;
let lastTickAt = 0;

/* ===========================
   éŸ³ï¼ˆWeb Audioï¼‰â€»ãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦
   iPhoneã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§åˆå›ã‚¢ãƒ³ãƒ­ãƒƒã‚¯å¿…è¦
=========================== */
let audioCtx = null;

function ensureAudio() {
  if (!audioCtx) {
    const Ctx = window.AudioContext || window.webkitAudioContext;
    audioCtx = new Ctx();
  }
  // iOSå¯¾ç­–: suspended ãªã‚‰ resume
  if (audioCtx.state === "suspended") audioCtx.resume();
}

function beep(freq, dur=0.06, type="square", gain=0.04) {
  if (!audioCtx) return;
  const t = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, t);

  // ã‚¯ãƒªãƒƒã‚¯æ„Ÿã‚’å‡ºã™çŸ­ã„ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(gain, t + 0.008);
  g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

  osc.connect(g);
  g.connect(audioCtx.destination);
  osc.start(t);
  osc.stop(t + dur + 0.01);
}

function tickSound() {
  // å°‘ã—ãƒ©ãƒ³ãƒ€ãƒ ã§æ°—æŒã¡ã‚ˆã
  beep(900 + Math.random()*120, 0.04, "square", 0.03);
}

function winSound() {
  // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬ã£ã½ã„3é€£
  beep(523.25, 0.10, "triangle", 0.06); // C5
  setTimeout(()=>beep(659.25, 0.10, "triangle", 0.06), 120); // E5
  setTimeout(()=>beep(783.99, 0.14, "triangle", 0.06), 240); // G5
}

/* ===========================
   æç”»ï¼ˆãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼‰
=========================== */
function drawWheel(){
  const r = canvas.width/2;
  const cx = r, cy = r;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const n = Math.max(items.length, 1);
  const step = 2*Math.PI/n;

  for (let i=0; i<n; i++){
    const start = angle + step*i;
    const end = start + step;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r-2,start,end);
    ctx.closePath();
    ctx.fillStyle = `hsl(${(i*360/n)|0}, 82%, 72%)`;
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,.10)";
    ctx.stroke();

    // æ–‡å­—
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(start + step/2);
    ctx.textAlign = "right";
    ctx.fillStyle = "rgba(0,0,0,.78)";
    ctx.font = "15px system-ui";
    const label = items[i] ?? "";
    ctx.fillText(label, r-18, 6);
    ctx.restore();
  }

  // ä¸­å¿ƒã®ä¸¸
  ctx.beginPath();
  ctx.arc(cx,cy,18,0,2*Math.PI);
  ctx.fillStyle = "rgba(255,255,255,.9)";
  ctx.fill();
  ctx.strokeStyle = "rgba(0,0,0,.10)";
  ctx.stroke();

  // çŸ¢å°ï¼ˆä¸Šï¼‰
  ctx.fillStyle = "#e11";
  ctx.beginPath();
  ctx.moveTo(cx-14, 8);
  ctx.lineTo(cx+14, 8);
  ctx.lineTo(cx, 30);
  ctx.closePath();
  ctx.fill();
  ctx.strokeStyle = "rgba(0,0,0,.12)";
  ctx.stroke();
}

function renderChips() {
  chipsEl.innerHTML = "";
  items.forEach(x => {
    const s = document.createElement("span");
    s.className = "chip";
    s.textContent = x;
    chipsEl.appendChild(s);
  });
}

/* ===========================
   å½“é¸åˆ¤å®š
   çŸ¢å°ã¯ã€Œä¸Š(12æ™‚æ–¹å‘)ã€ãªã®ã§ã€
   ãã“ã«æ¥ã¦ã„ã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è§’åº¦ã‹ã‚‰æ±‚ã‚ã‚‹
=========================== */
function pickWinner(){
  const n = items.length;
  const step = 2*Math.PI/n;

  // ä¸Šæ–¹å‘(= -90åº¦) ã‚’ 0åŸºæº–ã«åˆã‚ã›ã‚‹
  const pointer = -Math.PI/2;

  // (pointer - angle) ãŒã©ã®åŒºç”»ã«å…¥ã‚‹ã‹
  let a = (pointer - angle) % (2*Math.PI);
  if (a < 0) a += 2*Math.PI;

  const index = Math.floor(a / step);
  return items[index];
}

/* ===========================
   ç´™å¹é›ªï¼ˆç°¡æ˜“ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼‰
=========================== */
let confetti = [];
function spawnConfetti(){
  confetti = [];
  const W = fx.width, H = fx.height;
  const N = 120;
  for (let i=0; i<N; i++){
    confetti.push({
      x: W/2 + (Math.random()-0.5)*40,
      y: H/2 + (Math.random()-0.5)*40,
      vx: (Math.random()-0.5)*6,
      vy: -Math.random()*6 - 2,
      g: 0.12 + Math.random()*0.10,
      size: 4 + Math.random()*5,
      rot: Math.random()*Math.PI,
      vr: (Math.random()-0.5)*0.25,
      hue: Math.random()*360,
      life: 110 + (Math.random()*50|0),
    });
  }
  requestAnimationFrame(animateConfetti);
}

function animateConfetti(){
  fctx.clearRect(0,0,fx.width,fx.height);
  confetti.forEach(p => {
    p.vy += p.g;
    p.x += p.vx;
    p.y += p.vy;
    p.rot += p.vr;
    p.life--;

    fctx.save();
    fctx.translate(p.x, p.y);
    fctx.rotate(p.rot);
    fctx.fillStyle = `hsl(${p.hue}, 90%, 60%)`;
    fctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.7);
    fctx.restore();
  });

  confetti = confetti.filter(p => p.life > 0 && p.y < fx.height + 40);
  if (confetti.length) requestAnimationFrame(animateConfetti);
  else fctx.clearRect(0,0,fx.width,fx.height);
}

/* ===========================
   æ“ä½œ
=========================== */
function addItem(){
  const v = itemInput.value.trim();
  if (!v) return;
  items.push(v);
  itemInput.value = "";
  resultEl.textContent = "â€”";
  subEl.textContent = "å€™è£œè¿½åŠ ï¼ å›ã—ã¦æ±ºã‚ã‚ˆã†";
  drawWheel();
  renderChips();
}

function resetItems(){
  items = ["ã‚«ãƒ¬ãƒ¼","ãƒãƒ³ãƒãƒ¼ã‚°","ã†ã©ã‚“","ç„¼ããã°","å”æšã’","ã‚ªãƒ ãƒ©ã‚¤ã‚¹"];
  angle = 0;
  resultEl.textContent = "â€”";
  subEl.textContent = "åˆæœŸåŒ–ã—ãŸã‚ˆã€‚å›ã—ã¦ã­ï¼";
  drawWheel();
  renderChips();
}

function delLast(){
  if (items.length <= 2) {
    subEl.textContent = "å€™è£œã¯2ã¤ä»¥ä¸Šã‚ã‚‹ã¨æ¥½ã—ã„ã‚ˆï¼";
    return;
  }
  items.pop();
  resultEl.textContent = "â€”";
  subEl.textContent = "æœ€å¾Œã®å€™è£œã‚’å‰Šé™¤ã—ãŸã‚ˆ";
  drawWheel();
  renderChips();
}

function spin(){
  if (spinning) return;
  if (items.length < 2) {
    subEl.textContent = "å€™è£œã‚’2ã¤ä»¥ä¸Šå…¥ã‚Œã¦ã­ï¼";
    return;
  }

  ensureAudio(); // iOSã®åˆå›ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã‚’å…¼ã­ã‚‹

  spinning = true;
  spinBtn.disabled = true;
  addBtn.disabled = true;
  delLastBtn.disabled = true;
  resetBtn.disabled = true;

  resultEl.textContent = "â€¦";
  subEl.textContent = "ã„ãã‚ˆï¼";
  resultEl.classList.remove("pop");

  // é€Ÿåº¦ã¨æ¸›é€Ÿï¼ˆæ°—æŒã¡ã‚ˆãæ­¢ã¾ã‚‹ï¼‰
  let speed = 0.55 + Math.random()*0.30;  // åˆé€Ÿ
  const friction = 0.985;                // æ¸›è¡°
  const minSpeed = 0.0025;
  const startTime = performance.now();
  const minSpinMs = 1600 + Math.random()*600; // æœ€ä½å›è»¢æ™‚é–“

  function frame(t){
    angle += speed;
    speed *= friction;

    // tickéŸ³ï¼šå¢ƒç•Œã‚’è¶…ãˆã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã£ã½ãï¼ˆé€Ÿåº¦ãŒã‚ã‚‹æ™‚ã®ã¿ï¼‰
    const now = performance.now();
    if (speed > 0.02 && now - lastTickAt > 70) { // æ—©ã™ããªã„
      tickSound();
      lastTickAt = now;
    }

    drawWheel();

    const elapsed = t - startTime;
    if (elapsed < minSpinMs || speed > minSpeed){
      requestAnimationFrame(frame);
    } else {
      finishSpin();
    }
  }

  requestAnimationFrame(frame);
}

function finishSpin(){
  // ã´ãŸã£ã¨æ¼”å‡ºã§å°‘ã—ã ã‘æ•´ãˆã‚‹ï¼ˆå¾®èª¿æ•´ï¼‰
  const winner = pickWinner();

  winSound();
  spawnConfetti();

  resultEl.textContent = `âœ… ${winner} ã«æ±ºå®šï¼`;
  resultEl.classList.add("pop");
  subEl.textContent = "æ‹æ‰‹ã€œï¼ ã‚‚ã†ä¸€å›å›ã™ï¼Ÿ";

  spinning = false;
  spinBtn.disabled = false;
  addBtn.disabled = false;
  delLastBtn.disabled = false;
  resetBtn.disabled = false;
}

/* ã‚¤ãƒ™ãƒ³ãƒˆ */
addBtn.addEventListener("click", addItem);
itemInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") addItem(); });
spinBtn.addEventListener("click", spin);
delLastBtn.addEventListener("click", delLast);
resetBtn.addEventListener("click", resetItems);

// åˆæœŸæç”»
drawWheel();
renderChips();
</script>
</body>
</html>
